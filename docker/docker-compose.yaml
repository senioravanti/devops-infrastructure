name: devops-infrastructure

volumes:
  devops-infrastructure-portainer-data:
  devops-infrastructure-s3-data:
  devops-infrastructure-mongodb-data:

services:
  portainer:
    image: 'portainer/portainer-ce:lts'
    container_name: devops-infrastructure-portainer

    restart: unless-stopped

    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - 'devops-infrastructure-portainer-data:/data'
      - "${SSL_CERT_PATH}:/certs/fullchain.pem:ro"
      - "${SSL_KEY_PATH}:/certs/privkey.pem:ro"

    command: >
      --sslcert /certs/fullchain.pem
      --sslkey /certs/privkey.pem

    ports:
      - '8000:8000'
      - '9443:9443'

  minio:
    image: 'bitnami/minio:2025'
    container_name: 'devops-infrastructure-s3'

    restart: 'on-failure:3'

    healthcheck:
      test: [ "CMD", "curl", "-sSi", "http://127.0.0.1:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    env_file:
      - './environment/.env.minio'

    environment:
      MINIO_BROWSER: on

    volumes:
      - 'devops-infrastructure-s3-data:/bitnami/minio/data'

  webserver:
    image: 'nginx:1.29.0-alpine3.22'
    container_name: 'devops-infrastructure-webserver'

    restart: unless-stopped

    depends_on:
      minio:
        condition: service_healthy

    volumes:
      - './nginx/config/nginx.conf:/etc/nginx/nginx.conf:ro'
      - "${SSL_CERT_PATH}:/etc/ssl/private/nginx/fullchain.pem"
      - "${SSL_KEY_PATH}:/etc/ssl/private/nginx/privkey.pem"

    ports:
      - '9090:9090'
      - '9091:9091'

  mongodb:
    image: "mongo:${MONGODB_VERSION}-noble"
    container_name: 'devops-infrastructure-mongodb'

    restart: 'on-failure:3'
    
    volumes:
      - 'devops-infrastructure-mongodb-data:/data/db'
      - './mongodb/config/mongod.conf:/etc/mongod.conf:ro'
      - "${SSL_MONGODB_CERT_PATH}/cert.pem:/etc/ssl/mongodb/cert.pem:ro"
      - "${SSL_MONGODB_CERT_PATH}/fullchain.pem:/etc/ssl/mongodb/fullchain.pem:ro"

    env_file:
      - './environment/.env.mongodb'

    command: -f /etc/mongod.conf

    ports:
      - '27017:27017'
